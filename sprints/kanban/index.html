<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban Board</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#0d1117;color:#e6edf3;min-height:100vh;display:flex;flex-direction:column}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#0d1117}
::-webkit-scrollbar-thumb{background:#30363d;border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#8b949e}
.app-header{padding:12px 16px;border-bottom:1px solid #30363d;display:flex;align-items:center;gap:8px;flex-shrink:0}
.app-header h1{font-size:16px;font-weight:600;letter-spacing:.01em}
.logo{width:20px;height:20px;color:#58a6ff}
.board-controls{padding:10px 16px;border-bottom:1px solid #30363d;flex-shrink:0;background:#0d1117;position:sticky;top:0;z-index:10}
.search-row{position:relative;margin-bottom:8px}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#8b949e;pointer-events:none;width:14px;height:14px}
#search-input{width:100%;padding:7px 10px 7px 32px;background:#161b22;border:1px solid #30363d;border-radius:6px;color:#e6edf3;font-size:13px;font-family:inherit;outline:none;transition:border-color .15s}
#search-input::placeholder{color:#8b949e}
#search-input:focus{border-color:#58a6ff}
.filter-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.filter-label{font-size:12px;color:#8b949e;margin-right:2px}
.priority-filters{display:flex;gap:4px}
.filter-btn{padding:3px 10px;border:1px solid #30363d;border-radius:12px;background:transparent;color:#8b949e;font-size:12px;font-family:inherit;cursor:pointer;transition:all .15s;white-space:nowrap}
.filter-btn:hover{border-color:#8b949e;color:#e6edf3}
.filter-btn.active{background:#58a6ff;border-color:#58a6ff;color:#0d1117;font-weight:600}
.filter-btn[data-priority="medium"].active{background:#d29922;border-color:#d29922}
.filter-btn[data-priority="high"].active{background:#d18616;border-color:#d18616}
.filter-btn[data-priority="urgent"].active{background:#f85149;border-color:#f85149;color:#fff}
#active-label-filter{display:none;align-items:center;gap:4px;background:#21262d;border:1px solid #30363d;border-radius:12px;padding:2px 8px;font-size:12px}
#active-label-filter.visible{display:flex}
.remove-label-filter{background:none;border:none;color:#8b949e;cursor:pointer;padding:0;font-size:14px;line-height:1;margin-left:2px}
.remove-label-filter:hover{color:#f85149}
#clear-filters-btn{display:none;padding:3px 10px;border:1px solid #f85149;border-radius:12px;background:transparent;color:#f85149;font-size:12px;font-family:inherit;cursor:pointer;transition:all .15s;margin-left:auto}
#clear-filters-btn.visible{display:block}
#clear-filters-btn:hover{background:#f85149;color:#fff}
.board-wrapper{flex:1;overflow-x:auto;padding:16px}
.board{display:flex;gap:16px;min-height:calc(100vh - 180px);width:max-content;max-width:100%}
.column{background:#161b22;border:1px solid #30363d;border-radius:8px;display:flex;flex-direction:column;width:300px;min-width:280px;max-width:400px;max-height:calc(100vh - 180px);flex-shrink:0}
.column-header{padding:12px 12px 8px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #30363d;flex-shrink:0}
.column-title-row{display:flex;align-items:center;gap:8px}
.column-name{font-size:13px;font-weight:600;letter-spacing:.02em;text-transform:uppercase}
.card-count-badge{background:#21262d;border:1px solid #30363d;border-radius:10px;padding:1px 7px;font-size:11px;font-weight:600;color:#8b949e;min-width:22px;text-align:center}
.add-card-btn{background:none;border:none;color:#8b949e;cursor:pointer;padding:4px 6px;border-radius:4px;display:flex;align-items:center;justify-content:center;transition:color .15s,background .15s}
.add-card-btn:hover{color:#58a6ff;background:#21262d}
.add-card-btn:focus{outline:2px solid #58a6ff;outline-offset:2px}
.card-list{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
.add-card-form{display:none;flex-direction:column;gap:6px;padding:8px;background:#21262d;border:1px dashed #30363d;border-radius:6px;flex-shrink:0;animation:slideDown .15s ease}
.add-card-form.visible{display:flex}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.add-card-input{background:#0d1117;border:1px solid #30363d;border-radius:4px;color:#e6edf3;font-size:13px;font-family:inherit;padding:6px 8px;resize:none;outline:none}
.add-card-input:focus{border-color:#58a6ff}
.add-card-input::placeholder{color:#8b949e}
.add-card-actions{display:flex;gap:6px}
.btn-create{padding:5px 12px;background:#238636;border:1px solid #2ea043;border-radius:6px;color:#e6edf3;font-size:12px;font-family:inherit;cursor:pointer;transition:background .15s}
.btn-create:hover{background:#2ea043}
.btn-cancel{padding:5px 12px;background:transparent;border:1px solid #30363d;border-radius:6px;color:#8b949e;font-size:12px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-cancel:hover{border-color:#8b949e;color:#e6edf3}
.card{background:#21262d;border:1px solid #30363d;border-radius:6px;padding:10px 10px 8px 14px;cursor:pointer;position:relative;transition:border-color .15s,box-shadow .15s,opacity .15s;animation:cardSlide .15s ease;user-select:none;-webkit-user-select:none}
@keyframes cardSlide{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.card:hover{border-color:#8b949e;box-shadow:0 2px 8px rgba(0,0,0,.4)}
.card.dragging{opacity:.5}
.card.hidden{display:none}
.card[data-priority="low"]{border-left:3px solid #58a6ff}
.card[data-priority="medium"]{border-left:3px solid #d29922}
.card[data-priority="high"]{border-left:3px solid #d18616}
.card[data-priority="urgent"]{border-left:3px solid #f85149}
.card-title{font-size:14px;font-weight:600;margin-bottom:4px;word-break:break-word;line-height:1.4}
.card-desc{font-size:13px;color:#8b949e;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:6px;line-height:1.45;word-break:break-word}
.card-labels{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px}
.label-chip{font-size:11px;padding:2px 7px;border-radius:10px;font-weight:500;color:#9da5ae;background:#30363d;border:1px solid #444c56;cursor:pointer;transition:opacity .15s}
.label-chip:hover{opacity:.8}
.card-footer{display:flex;align-items:center;justify-content:space-between}
.card-date{font-size:11px;color:#8b949e}
.drag-placeholder{background:rgba(88,166,255,.06);border:2px dashed #58a6ff;border-radius:6px;height:60px;flex-shrink:0;pointer-events:none}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(1,4,9,.75);z-index:100;align-items:center;justify-content:center;padding:16px}
.modal-overlay.visible{display:flex;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:#161b22;border:1px solid #30363d;border-radius:10px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;box-shadow:0 16px 48px rgba(1,4,9,.8)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px;border-bottom:1px solid #30363d}
.modal-header h2{font-size:15px;font-weight:600}
.modal-close-btn{background:none;border:none;color:#8b949e;cursor:pointer;font-size:20px;line-height:1;padding:4px 6px;border-radius:4px;transition:color .15s,background .15s}
.modal-close-btn:hover{color:#e6edf3;background:#21262d}
.modal-body{padding:16px 20px;display:flex;flex-direction:column;gap:14px}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-label{font-size:12px;font-weight:600;color:#8b949e;text-transform:uppercase;letter-spacing:.04em}
.form-input,.form-textarea,.form-select{background:#0d1117;border:1px solid #30363d;border-radius:6px;color:#e6edf3;font-size:14px;font-family:inherit;padding:8px 10px;outline:none;transition:border-color .15s}
.form-input:focus,.form-textarea:focus,.form-select:focus{border-color:#58a6ff}
.form-textarea{resize:vertical;min-height:80px;max-height:200px;line-height:1.5}
.form-select option{background:#161b22;color:#e6edf3}
.label-input-row{display:flex;gap:6px}
.label-input-row .form-input{flex:1}
.btn-add-label{padding:8px 12px;background:#21262d;border:1px solid #30363d;border-radius:6px;color:#8b949e;font-size:13px;font-family:inherit;cursor:pointer;transition:all .15s;white-space:nowrap}
.btn-add-label:hover{border-color:#58a6ff;color:#58a6ff}
.modal-labels-container{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.modal-label-chip{display:inline-flex;align-items:center;gap:4px;font-size:12px;padding:3px 8px;border-radius:10px;background:#30363d;border:1px solid #444c56;color:#9da5ae}
.modal-label-chip .remove-label{background:none;border:none;color:#8b949e;cursor:pointer;font-size:14px;line-height:1;padding:0 1px;transition:color .15s}
.modal-label-chip .remove-label:hover{color:#f85149}
.modal-footer{padding:12px 20px 16px;border-top:1px solid #30363d;display:flex;align-items:center;justify-content:space-between}
.btn-delete{padding:7px 14px;background:transparent;border:1px solid #f85149;border-radius:6px;color:#f85149;font-size:13px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-delete:hover{background:#f85149;color:#fff}
.btn-save{padding:7px 16px;background:#238636;border:1px solid #2ea043;border-radius:6px;color:#e6edf3;font-size:13px;font-family:inherit;cursor:pointer;transition:background .15s}
.btn-save:hover{background:#2ea043}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(1,4,9,.8);z-index:200;align-items:center;justify-content:center;padding:16px}
.confirm-overlay.visible{display:flex}
.confirm-box{background:#161b22;border:1px solid #30363d;border-radius:8px;padding:20px;width:100%;max-width:360px;box-shadow:0 8px 32px rgba(1,4,9,.8)}
.confirm-box h3{font-size:15px;font-weight:600;margin-bottom:8px}
.confirm-box p{font-size:13px;color:#8b949e;margin-bottom:16px;line-height:1.5}
.confirm-actions{display:flex;gap:8px;justify-content:flex-end}
.btn-cc{padding:6px 14px;background:transparent;border:1px solid #30363d;border-radius:6px;color:#8b949e;font-size:13px;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-cc:hover{border-color:#8b949e;color:#e6edf3}
.btn-cd{padding:6px 14px;background:#da3633;border:1px solid #f85149;border-radius:6px;color:#fff;font-size:13px;font-family:inherit;cursor:pointer;transition:background .15s}
.btn-cd:hover{background:#f85149}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#21262d;border:1px solid #30363d;border-radius:6px;padding:10px 18px;font-size:13px;color:#e6edf3;box-shadow:0 4px 16px rgba(1,4,9,.6);z-index:300;transition:transform .25s ease,opacity .25s ease;opacity:0;white-space:nowrap}
#toast.visible{transform:translateX(-50%) translateY(0);opacity:1}
.empty-col{text-align:center;padding:24px 12px;color:#8b949e;font-size:12px;pointer-events:none}
@media(min-width:1024px){.board-wrapper{padding:20px 24px}.board{width:auto;max-width:1280px;margin:0 auto}.column{flex:1}.board-controls{padding:12px 24px}}
@media(max-width:767px){.board{flex-direction:column;width:100%;gap:12px}.column{width:100%;min-width:0;max-width:100%;max-height:none}.card-list{max-height:400px}}
@media(min-width:768px) and (max-width:1023px){.column{width:calc(33.333% - 11px);min-width:0}.board{width:100%}}
</style>
</head>
<body>
<header class="app-header">
<svg class="logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
<h1>Kanban Board</h1>
</header>
<div class="board-controls" role="search">
<div class="search-row">
<svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
<input type="text" id="search-input" placeholder="Search cards..." autocomplete="off" aria-label="Search cards">
</div>
<div class="filter-row" role="group" aria-label="Priority filters">
<span class="filter-label">Priority:</span>
<div class="priority-filters">
<button class="filter-btn active" data-priority="all" aria-pressed="true">All</button>
<button class="filter-btn" data-priority="low" aria-pressed="false">Low</button>
<button class="filter-btn" data-priority="medium" aria-pressed="false">Medium</button>
<button class="filter-btn" data-priority="high" aria-pressed="false">High</button>
<button class="filter-btn" data-priority="urgent" aria-pressed="false">Urgent</button>
</div>
<div id="active-label-filter" aria-live="polite"><span id="active-label-text"></span><button class="remove-label-filter" aria-label="Remove label filter">×</button></div>
<button id="clear-filters-btn" aria-label="Clear all filters">Clear filters</button>
</div>
</div>
<div class="board-wrapper"><main class="board" id="board" role="main"></main></div>
<div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
<div class="modal" id="modal">
<div class="modal-header"><h2 id="modal-title">Edit Card</h2><button class="modal-close-btn" id="modal-close-btn" aria-label="Close modal">×</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label" for="modal-title-input">Title</label><input type="text" id="modal-title-input" class="form-input" maxlength="100" placeholder="Card title"></div>
<div class="form-group"><label class="form-label" for="modal-desc-input">Description</label><textarea id="modal-desc-input" class="form-textarea" placeholder="Add a description..."></textarea></div>
<div class="form-group"><label class="form-label" for="modal-priority-select">Priority</label>
<select id="modal-priority-select" class="form-select"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
<div class="form-group"><label class="form-label" for="modal-label-input">Labels</label>
<div class="label-input-row"><input type="text" id="modal-label-input" class="form-input" placeholder="Add a label..." maxlength="30"><button class="btn-add-label" id="btn-add-label-modal">Add</button></div>
<div class="modal-labels-container" id="modal-labels-container"></div></div>
</div>
<div class="modal-footer"><button class="btn-delete" id="btn-delete-card" aria-label="Delete card">Delete card</button><button class="btn-save" id="btn-save-card">Save changes</button></div>
</div>
</div>
<div class="confirm-overlay" id="confirm-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirm-title">
<div class="confirm-box"><h3 id="confirm-title">Delete this card?</h3><p>This cannot be undone (Ctrl+Z to undo immediately after).</p>
<div class="confirm-actions"><button class="btn-cc" id="btn-confirm-cancel">Cancel</button><button class="btn-cd" id="btn-confirm-delete">Delete</button></div></div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<script>
'use strict';
const SK='kanban_board_state';
const $=id=>document.getElementById(id);
let S={columns:[],cards:{}},undoSnap=null,filt={priority:'all',label:null,search:''},sT=null,tT=null,eId=null;
let dS=null,dG=null,dSrc={cid:null,lid:null},dTgt={lid:null,idx:null},tTm=null,tAct=false;

const LC=['#1f6feb','#388bfd','#2d7d4e','#3fb950','#7d4e15','#d29922','#6e2b8b','#bc8cff','#b91c1c','#f85149','#0e7490','#2dd4bf'];
function lclr(l){let h=0;for(let i=0;i<l.length;i++)h=(h*31+l.charCodeAt(i))&0xffffffff;return LC[Math.abs(h)%LC.length];}
function save(){try{localStorage.setItem(SK,JSON.stringify(S));}catch(e){}}
function load(){try{const r=localStorage.getItem(SK);if(!r)return 0;const p=JSON.parse(r);if(!p.columns||!p.cards)return 0;S=p;return 1;}catch(e){return 0;}}
function defS(){S={columns:[{id:'todo',name:'To Do',cardIds:[]},{id:'in-progress',name:'In Progress',cardIds:[]},{id:'done',name:'Done',cardIds:[]}],cards:{}};}
function gid(){return 'c'+Date.now()+Math.random().toString(36).slice(2,6);}
function fd(iso){return new Date(iso).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function toast(m){const t=$('toast');t.textContent=m;t.classList.add('visible');clearTimeout(tT);tT=setTimeout(()=>t.classList.remove('visible'),3000);}
function snap(){undoSnap=JSON.parse(JSON.stringify(S));}
function doUndo(){if(!undoSnap)return;S=undoSnap;undoSnap=null;save();render();toast('↩ Undo applied');}
function filtUI(){const has=filt.search||filt.priority!=='all'||filt.label;$('clear-filters-btn').classList.toggle('visible',!!has);const lEl=$('active-label-filter');if(filt.label){lEl.classList.add('visible');$('active-label-text').textContent=filt.label;}else lEl.classList.remove('visible');}
function mkChip(l,c){const ch=document.createElement('span');ch.className='modal-label-chip';ch.dataset.label=l;const cl=lclr(l);ch.style.color=cl;ch.style.borderColor=cl+'33';ch.style.background=cl+'18';ch.innerHTML=`${esc(l)}<button class="remove-label" aria-label="Remove label ${esc(l)}">×</button>`;ch.querySelector('.remove-label').addEventListener('click',()=>ch.remove());c.appendChild(ch);return ch;}

function match(c){
  const q=filt.search.toLowerCase();
  if(q&&!c.title.toLowerCase().includes(q)&&!(c.description||'').toLowerCase().includes(q)&&!c.labels.some(l=>l.toLowerCase().includes(q)))return 0;
  if(filt.priority!=='all'&&c.priority!==filt.priority)return 0;
  if(filt.label&&!c.labels.includes(filt.label))return 0;
  return 1;
}

function applyF(){
  S.columns.forEach(col=>{
    let v=0;col.cardIds.forEach(id=>{
      const c=S.cards[id],el=document.querySelector(`.card[data-id="${id}"]`);
      if(!el)return;const show=c&&match(c);el.classList.toggle('hidden',!show);if(show)v++;
    });
    const b=document.querySelector(`.column[data-col-id="${col.id}"] .card-count-badge`);
    if(b)b.textContent=`(${v})`;
  });
  filtUI();
}

function mkCard(c){
  const el=document.createElement('div');
  el.className='card';el.dataset.id=c.id;el.dataset.priority=c.priority;
  el.setAttribute('role','article');el.setAttribute('aria-label','Card: '+c.title);el.setAttribute('tabindex','0');
  let labs='';
  if(c.labels&&c.labels.length){
    labs='<div class="card-labels">';
    c.labels.forEach(l=>{const cl=lclr(l);labs+=`<span class="label-chip" data-label="${esc(l)}" style="color:${cl};border-color:${cl}33;background:${cl}18" tabindex="0" role="button" aria-label="Filter by label ${esc(l)}">${esc(l)}</span>`;});
    labs+='</div>';
  }
  el.innerHTML=`<div class="card-title">${esc(c.title)}</div>${c.description?`<div class="card-desc">${esc(c.description)}</div>`:''}${labs}<div class="card-footer"><span class="card-date">${fd(c.created)}</span></div>`;
  el.addEventListener('click',e=>{if(!e.target.classList.contains('label-chip'))openMod(c.id);});
  el.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();openMod(c.id);}});
  el.querySelectorAll('.label-chip').forEach(ch=>{
    ch.addEventListener('click',e=>{e.stopPropagation();const l=ch.dataset.label;filt.label=(filt.label===l)?null:l;applyF();});
    ch.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();ch.click();}});
  });
  el.addEventListener('mousedown',onMD);el.addEventListener('touchstart',onTS,{passive:false});
  return el;
}

function mkCol(col){
  const el=document.createElement('div');
  el.className='column';el.dataset.colId=col.id;
  el.setAttribute('role','region');el.setAttribute('aria-label',col.name+' column');
  const hdr=document.createElement('div');hdr.className='column-header';
  hdr.innerHTML=`<div class="column-title-row"><span class="column-name">${esc(col.name)}</span><span class="card-count-badge">(0)</span></div><button class="add-card-btn" aria-label="Add card to ${esc(col.name)}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg></button>`;
  el.appendChild(hdr);
  const form=document.createElement('div');form.className='add-card-form';
  form.innerHTML=`<input type="text" class="add-card-input" placeholder="Card title..." maxlength="100" aria-label="New card title"><div class="add-card-actions"><button class="btn-create">Add card</button><button class="btn-cancel">Cancel</button></div>`;
  el.appendChild(form);
  const list=document.createElement('div');list.className='card-list';list.dataset.colId=col.id;el.appendChild(list);
  const inp=form.querySelector('.add-card-input');
  hdr.querySelector('.add-card-btn').addEventListener('click',()=>{form.classList.add('visible');inp.value='';inp.focus();});
  form.querySelector('.btn-cancel').addEventListener('click',()=>form.classList.remove('visible'));
  form.querySelector('.btn-create').addEventListener('click',()=>mkNewCard(col.id,inp.value.trim(),form));
  inp.addEventListener('keydown',e=>{
    if(e.key==='Enter'){e.preventDefault();mkNewCard(col.id,inp.value.trim(),form);}
    if(e.key==='Escape')form.classList.remove('visible');
  });
  list.addEventListener('dragover',e=>e.preventDefault());list.addEventListener('drop',e=>e.preventDefault());
  return el;
}

function mkNewCard(colId,title,form){
  if(!title)return;snap();
  const col=S.columns.find(c=>c.id===colId);if(!col)return;
  const id=gid();
  S.cards[id]={id,title,description:'',priority:'medium',labels:[],created:new Date().toISOString()};
  col.cardIds.unshift(id);save();if(form)form.classList.remove('visible');render();
}

function render(){
  const board=document.getElementById('board');board.innerHTML='';
  S.columns.forEach(col=>{
    const ce=mkCol(col),list=ce.querySelector('.card-list');let v=0;
    col.cardIds.forEach(id=>{
      const c=S.cards[id];if(!c)return;
      const ce2=mkCard(c);list.appendChild(ce2);
      if(match(c))v++;else ce2.classList.add('hidden');
    });
    if(!col.cardIds.length){const e=document.createElement('div');e.className='empty-col';e.textContent='No cards yet';list.appendChild(e);}
    ce.querySelector('.card-count-badge').textContent=`(${v})`;board.appendChild(ce);
  });filtUI();
}

function openMod(id){
  const c=S.cards[id];if(!c)return;eId=id;
  $('modal-title-input').value=c.title;$('modal-desc-input').value=c.description||'';
  $('modal-priority-select').value=c.priority;
  renderLabels(c.labels||[]);$('modal-overlay').classList.add('visible');$('modal-title-input').focus();
}
function closeMod(sv){if(sv&&eId){saveMod(1);render();}$('modal-overlay').classList.remove('visible');eId=null;}
function saveMod(skip){
  if(!eId)return;const c=S.cards[eId];if(!c)return;
  const t=$('modal-title-input').value.trim();if(!t)return;
  snap();c.title=t;c.description=$('modal-desc-input').value.trim();
  c.priority=$('modal-priority-select').value;
  c.labels=Array.from(document.querySelectorAll('#modal-labels-container .modal-label-chip')).map(ch=>ch.dataset.label);
  save();if(!skip)render();
}
function renderLabels(labels){const c=$('modal-labels-container');c.innerHTML='';labels.forEach(l=>mkChip(l,c));}
function addLbl(){
  const inp=$('modal-label-input'),val=inp.value.trim();if(!val)return;
  const c=$('modal-labels-container');
  if(Array.from(c.querySelectorAll('.modal-label-chip')).some(ch=>ch.dataset.label===val)){inp.value='';return;}
  mkChip(val,c);inp.value='';
}

$('modal-close-btn').addEventListener('click',()=>closeMod(1));
$('modal-overlay').addEventListener('click',e=>{if(e.target===$('modal-overlay'))closeMod(1);});
$('btn-save-card').addEventListener('click',()=>{saveMod(0);eId=null;$('modal-overlay').classList.remove('visible');});
$('btn-add-label-modal').addEventListener('click',addLbl);
$('modal-label-input').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();addLbl();}});
['modal-title-input','modal-desc-input','modal-priority-select'].forEach(id=>{$(id).addEventListener('blur',()=>{if(eId)saveMod(1);});});

$('modal').addEventListener('keydown',e=>{
  if(e.key!=='Tab')return;
  const els=Array.from($('modal').querySelectorAll('button,input,textarea,select')).filter(x=>!x.disabled);
  if(!els.length)return;
  if(e.shiftKey){if(document.activeElement===els[0]){e.preventDefault();els[els.length-1].focus();}}
  else{if(document.activeElement===els[els.length-1]){e.preventDefault();els[0].focus();}}
});

$('btn-delete-card').addEventListener('click',()=>{$('confirm-overlay').classList.add('visible');$('btn-confirm-delete').focus();});
$('btn-confirm-cancel').addEventListener('click',()=>$('confirm-overlay').classList.remove('visible'));
$('btn-confirm-delete').addEventListener('click',()=>{
  $('confirm-overlay').classList.remove('visible');if(!eId)return;
  snap();const id=eId;S.columns.forEach(col=>{col.cardIds=col.cardIds.filter(c=>c!==id);});
  delete S.cards[id];save();eId=null;$('modal-overlay').classList.remove('visible');
  render();toast('Card deleted — Ctrl+Z to undo');
});

document.querySelectorAll('.filter-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    filt.priority=btn.dataset.priority;
    document.querySelectorAll('.filter-btn').forEach(b=>{b.classList.toggle('active',b===btn);b.setAttribute('aria-pressed',b===btn?'true':'false');});
    applyF();
  });
});
$('search-input').addEventListener('input',e=>{clearTimeout(sT);sT=setTimeout(()=>{filt.search=e.target.value;applyF();},150);});
document.querySelector('.remove-label-filter').addEventListener('click',()=>{filt.label=null;applyF();render();});
$('clear-filters-btn').addEventListener('click',()=>{
  filt={priority:'all',label:null,search:''};$('search-input').value='';
  document.querySelectorAll('.filter-btn').forEach(b=>{const a=b.dataset.priority==='all';b.classList.toggle('active',a);b.setAttribute('aria-pressed',a?'true':'false');});
  render();
});

document.addEventListener('keydown',e=>{
  const tag=(document.activeElement&&document.activeElement.tagName)||'';
  const inI=tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT';
  if(e.key==='Escape'){
    if($('modal-overlay').classList.contains('visible')){closeMod(1);return;}
    if($('confirm-overlay').classList.contains('visible')){$('confirm-overlay').classList.remove('visible');return;}
    document.querySelectorAll('.add-card-form.visible').forEach(f=>f.classList.remove('visible'));
    if(filt.search){filt.search='';$('search-input').value='';applyF();}return;
  }
  if(inI)return;
  if(e.key==='n'||e.key==='N'){e.preventDefault();const col=document.querySelector('.column');if(col){const f=col.querySelector('.add-card-form'),i=col.querySelector('.add-card-input');if(f&&i){f.classList.add('visible');i.value='';i.focus();}}}
  if(e.key==='/'){e.preventDefault();$('search-input').focus();}
  if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();doUndo();}
});

function onMD(e){
  if(e.button!==0||e.target.tagName==='BUTTON'||e.target.closest('button'))return;
  const ce=e.currentTarget,list=ce.closest('.card-list');if(!list)return;
  let moved=0;const sx=e.clientX,sy=e.clientY;
  function onMv(ev){if(!moved){if(Math.abs(ev.clientX-sx)<4&&Math.abs(ev.clientY-sy)<4)return;moved=1;startDrag(ce,list,ev.clientX,ev.clientY);}if(dS)moveDrag(ev.clientX,ev.clientY);}
  function onUp(ev){document.removeEventListener('mousemove',onMv);document.removeEventListener('mouseup',onUp);if(moved&&dS)endDrag();else if(!moved)openMod(ce.dataset.id);}
  document.addEventListener('mousemove',onMv);document.addEventListener('mouseup',onUp);e.preventDefault();
}
function startDrag(ce,list,x,y){
  dSrc.cid=ce.dataset.id;dSrc.lid=list.dataset.colId;ce.classList.add('dragging');
  dG=ce.cloneNode(true);const r=ce.getBoundingClientRect();
  dG.style.cssText=`position:fixed;top:${r.top}px;left:${r.left}px;width:${r.width}px;opacity:.85;pointer-events:none;z-index:500;border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,.5);transform:rotate(2deg);transition:none`;
  document.body.appendChild(dG);dS={ox:x-r.left,oy:y-r.top,ce};
}
function moveDrag(x,y){
  if(!dG)return;dG.style.left=(x-dS.ox)+'px';dG.style.top=(y-dS.oy)+'px';
  rmPh();
  for(const list of document.querySelectorAll('.card-list')){
    const r=list.getBoundingClientRect();
    if(x>=r.left&&x<=r.right&&y>=r.top&&y<=r.bottom){
      const cards=Array.from(list.querySelectorAll('.card:not(.hidden):not(.dragging)'));
      let bef=null;for(const c of cards){const cr=c.getBoundingClientRect();if(y<cr.top+cr.height/2){bef=c;break;}}
      const ph=document.createElement('div');ph.className='drag-placeholder';ph.id='drag-ph';
      if(bef)list.insertBefore(ph,bef);else list.appendChild(ph);
      dTgt.lid=list.dataset.colId;dTgt.idx=bef?cards.indexOf(bef):cards.length;break;
    }
  }
}
function rmPh(){const p=document.getElementById('drag-ph');if(p)p.remove();}
function endDrag(){
  if(!dS)return;dS.ce.classList.remove('dragging');if(dG){dG.remove();dG=null;}rmPh();
  if(dTgt.lid){
    snap();const cid=dSrc.cid;
    const from=S.columns.find(c=>c.id===dSrc.lid),to=S.columns.find(c=>c.id===dTgt.lid);
    if(from&&to&&cid){
      from.cardIds=from.cardIds.filter(i=>i!==cid);
      const vis=to.cardIds.filter(i=>{const c=S.cards[i];return c&&match(c);});
      if(dTgt.idx>=vis.length)to.cardIds.push(cid);
      else{const bi=vis[dTgt.idx],ri=to.cardIds.indexOf(bi);if(ri>=0)to.cardIds.splice(ri,0,cid);else to.cardIds.push(cid);}
      save();render();
    }
  }
  dS=null;dTgt={lid:null,idx:null};
}

function onTS(e){
  const ce=e.currentTarget,list=ce.closest('.card-list'),t=e.touches[0];
  tTm=setTimeout(()=>{tAct=true;startDrag(ce,list,t.clientX,t.clientY);},300);
  function onMv(ev){clearTimeout(tTm);if(!tAct)return;ev.preventDefault();const tc=ev.touches[0];moveDrag(tc.clientX,tc.clientY);}
  function onEnd(ev){clearTimeout(tTm);ce.removeEventListener('touchmove',onMv);ce.removeEventListener('touchend',onEnd);if(tAct){endDrag();tAct=false;}}
  ce.addEventListener('touchmove',onMv,{passive:false});ce.addEventListener('touchend',onEnd);
}

(function(){if(!load())defS();render();})();
</script>
</body>
</html>
