# Implementation Plan (rendered from state)

Generated: 2026-02-17T14:17:33.952124


## Foundation

- [x] **1.1**: Create project scaffolding: directory structure (backend/, frontend/, data/, tests/), .gitignore (excluding data/, *.db, __pycache__/), requirements.txt (fastapi, uvicorn), and the FastAPI application entry point (backend/main.py) with configurable port via PORT env var and --port CLI flag. Mount static files from frontend/ directory. Include a minimal frontend/index.html placeholder to verify static serving works. IMPORTANT: Port 8000 is occupied on this system. The app MUST support PORT env var and --port CLI arg. Dev server should default to a configurable port (suggest 8765 as fallback). Tests must NEVER use a fixed port — use socket to find a free port dynamically.
  - Value: Establishes the runnable application skeleton so the freelancer can start the server and see a page — the first proof of life that the system works end-to-end from server to browser.
  - Acceptance: Running uvicorn backend.main:app --port 9000 from the sprint directory starts the server without errors. GET / serves the placeholder HTML. GET /api/timer returns a JSON response (empty/null is fine at this stage). The .gitignore correctly excludes data/ and *.db files.

- [x] **1.2**: Implement the SQLite database layer (backend/database.py): connection management using sqlite3 stdlib with PRAGMA foreign_keys = ON enabled on every connection (SQLite does not enforce foreign keys by default). CREATE TABLE IF NOT EXISTS for projects table (id, name, client_name, hourly_rate, color, archived, created_at, updated_at) and time_entries table (id, project_id FK, description, start_time, end_time nullable, duration_seconds nullable, created_at, updated_at). Auto-migration runs on app startup. Use a configurable DB path (default: data/timetracker.db relative to sprint dir) so tests can use temp databases. Ensure the data/ directory is created automatically if missing.
  - Value: Enables persistent storage so the freelancer never loses tracked time — closing the browser, restarting the server, or rebooting the machine preserves all projects and entries.
  - Acceptance: Importing database module and calling init_db() creates a SQLite file with both tables. Table schemas match the PRD exactly (column names, types, defaults, foreign key). Calling init_db() twice is idempotent. The data/ directory is auto-created.
  - Deps: 1.1

- [x] **1.3**: Define all Pydantic request/response models (backend/models.py): ProjectCreate, ProjectResponse, ProjectUpdate for projects; EntryCreate (manual), EntryResponse for time entries; TimerStartRequest, TimerResponse for the timer; and error response model. All datetime fields use ISO 8601 format. EntryResponse includes computed fields project_name and project_color joined from projects table. TimerResponse includes elapsed_seconds computed from start_time vs now.
  - Value: Provides type-safe data contracts between frontend and backend, ensuring the freelancer always receives well-structured, validated data — preventing corrupt entries and confusing errors.
  - Acceptance: All models can be instantiated with valid data and reject invalid data (e.g., missing required fields). Datetime fields serialize to ISO 8601 strings. ProjectResponse includes all fields from PRD section 3.1. EntryResponse includes project_name and project_color. TimerResponse includes elapsed_seconds.
  - Deps: 1.1


## Core

- [x] **1.4**: Implement Project API endpoints (backend/routes/projects.py) and register as FastAPI router: GET /api/projects (list all, with ?active=true filter for non-archived), POST /api/projects (create, returns 201), GET /api/projects/{id} (get one, 404 if missing), PUT /api/projects/{id} (update, partial fields accepted), DELETE /api/projects/{id} (only if no entries, 409 if has entries, 204 on success). All responses use Pydantic models. Proper error handling with JSON error responses.
  - Value: Enables the freelancer to create and manage client projects — the organizational backbone that every time entry and report depends on. Without projects, there is nothing to track time against.
  - Acceptance: POST /api/projects with {name: "Test", client_name: "Client", hourly_rate: 150, color: "#58a6ff"} returns 201 with the created project including an auto-generated id. GET /api/projects returns a list containing the created project. GET /api/projects?active=true excludes archived projects. PUT updates fields. DELETE returns 204 for project with no entries and 409 for project with entries. GET for nonexistent id returns 404.
  - Deps: 1.2, 1.3

- [x] **1.5**: Implement Timer API endpoints (backend/routes/entries.py — timer section): GET /api/timer (return running timer with elapsed_seconds computed from start_time vs now, or null if none), POST /api/timer/start (create time_entry with end_time=NULL, auto-stop any existing running timer first — auto-switch behavior, returns 201), POST /api/timer/stop (find running entry, set end_time=now, compute duration_seconds, return completed entry). Also implement basic Time Entries endpoints: GET /api/entries (with ?date=YYYY-MM-DD filter for today view, and ?from=&to= for date ranges), POST /api/entries (manual entry with start_time and end_time required), PUT /api/entries/{id}, DELETE /api/entries/{id} (204). All entry responses include project_name and project_color from joined project data.
  - Value: Delivers the core timer functionality — the freelancer can start tracking time with one click, stop it when done, and the entry is saved automatically. The server-side timer state means they can close their browser without losing the running timer. Manual entry support lets them backfill forgotten time.
  - Acceptance: POST /api/timer/start with {project_id: 1} creates a running entry (end_time NULL) and returns 201 with elapsed_seconds. GET /api/timer returns the running timer with accurate elapsed_seconds, or null/empty JSON if no timer is running. POST /api/timer/stop sets end_time and duration_seconds, returns the completed entry. POST /api/timer/stop when no timer is running returns 404 with {"detail": "No running timer"}. Starting a new timer while one is running auto-stops the old one (old entry gets end_time and duration_seconds, new entry is created). GET /api/entries?date=2026-02-17 returns only entries for that date with project_name and project_color. GET /api/entries?from=DATE&to=DATE returns entries in that date range. Manual POST /api/entries with start_time and end_time required creates a completed entry with computed duration_seconds. Only one timer can run at a time.
  - Deps: 1.2, 1.3, 1.4

- [x] **1.6**: Build the complete frontend SPA shell (frontend/index.html, frontend/style.css, frontend/app.js): Tab-based navigation with Timer (default), Weekly, Projects, Reports tabs. Full dark theme implementation per PRD 4.6 specs (backgrounds #0d1117/#161b22/#21262d, text #e6edf3/#8b949e, accent colors, borders #30363d). System font stack with specified sizes. Responsive layout: sidebar navigation at >=1024px desktop, top tabs at 768-1023px tablet. Loading states (spinner) and error toast notifications. The app.js should implement a router/state manager for tab switching and API communication layer using fetch() with proper error handling. Include the project color palette (#58a6ff, #3fb950, #f85149, #d29922, #bc8cff, #f778ba, #79c0ff, #56d364).
  - Value: Gives the freelancer a professional, polished interface they can trust for daily use — the dark theme reduces eye strain during long work sessions, and responsive layout means it works on both their desktop monitor and tablet.
  - Acceptance: Opening the app in a browser shows a dark-themed SPA with 4 navigation tabs. Clicking tabs switches views without page reload. The dark theme colors match PRD 4.6 specifications. Layout is sidebar-style at 1024px+ and top-tabs at 768px. Timer view is shown by default. No console errors on load.
  - Deps: 1.1

- [x] **1.7**: Implement the complete Timer View (dashboard/default view in app.js), combining the active timer and today's entries into one cohesive panel. Active timer section: project dropdown (fetched from GET /api/projects?active=true, showing color indicators), description text input, Start/Stop toggle button (green Start/#3fb950 when idle, red Stop/#f85149 when running). Real-time HH:MM:SS display updating every second via setInterval, computed from server start_time (not cumulative increments). On page load, check GET /api/timer — if a timer is running, show it with correct elapsed time. Start calls POST /api/timer/start, Stop calls POST /api/timer/stop. Timer display uses 32px monospace bold font. Poll timer status every 5 seconds for cross-tab accuracy. Today's entries section: Fetch GET /api/entries?date=<today> and render a chronological list (most recent first). Each entry shows: project color dot, project name, description, start-end times (HH:MM format), duration (HH:MM). Delete button on each entry (with confirmation dialog) calling DELETE /api/entries/{id}. Add Manual Entry button opens a form with: date (defaults today), start time, end time, project dropdown, description — submits to POST /api/entries. Today Summary: total hours today (HH:MM format) and breakdown by project (color dot + name + hours). Refresh entries list after any mutation (stop timer, add manual, delete).
  - Value: Delivers the core user experience — the freelancer sees a prominent timer, picks their project, clicks Start, and watches it count. Below the timer, they see all of today's entries with project colors and total hours. This is the primary screen they interact with dozens of times per day. Manual entry lets them backfill forgotten time. Server-synced time means the display is always accurate.
  - Acceptance: Selecting a project and clicking Start shows a running HH:MM:SS counter in 32px monospace bold. The counter updates every second with correct elapsed time computed from start_time. Clicking Stop saves the entry and it appears in today list. Reloading the page while timer is running shows the timer still running with correct elapsed time. The Start button is green, the Stop button is red. Project dropdown shows only active projects with color indicators. After stopping a timer, the entry appears in the today list with correct project color dot, name, times, and duration. Entries are ordered most recent first. Total hours matches the sum of entry durations. Project breakdown shows correct hours per project. Add Manual Entry form creates an entry that appears in the list immediately. Delete button removes entry after confirmation. The entries list is empty/shows placeholder when no entries exist for today.
  - Deps: 1.5, 1.6

- [x] **1.9**: Implement the Projects View frontend (app.js, PRD section 4.4): Project list as cards showing color swatch, name, client name, hourly rate. Active and Archived tabs to filter display (archived tab shows message that archive functionality is coming in a future update). New Project button opens a form/modal with: name (required), client name, hourly rate (number input), color picker (preset palette of 8 colors from PRD 4.6). Save calls POST /api/projects. This view provides the project management UI that complements the project dropdown in the timer. Scope for this epic: create + list + display only. Full edit/archive/delete UI is deferred to Epic 2.
  - Value: Enables the freelancer to create and organize their client projects with meaningful metadata (client name, rate, color) — this is the setup step that makes all time tracking meaningful. Without projects configured with rates, the timesheet cannot calculate billable amounts.
  - Acceptance: Projects tab shows project cards with color swatch, name, client, and rate. New Project button opens a form. Submitting with valid data creates a project that appears in the list and in the timer dropdown. Color picker shows 8 preset colors. Empty state shows a helpful message when no projects exist.
  - Deps: 1.6, 1.4

- [ ] **VRC-1**: Implement Reports/Timesheet API endpoints (backend/routes/reports.py): GET /api/reports/timesheet with ?from=DATE&to=DATE and optional ?project_id= parameters, returning entries grouped by date with project details, daily subtotals, and grand totals including calculated amounts (hours x hourly_rate). GET /api/reports/timesheet/csv with same parameters, returning a downloadable CSV file with columns: date, project, client, description, hours, rate, amount. Register the reports router in main.py.
  - Value: Without these backend endpoints, the Reports tab in the frontend is completely broken — the freelancer cannot generate timesheets or export CSV files, which is a core Vision deliverable (#5 Generate Timesheets). The frontend UI is fully built but calls non-existent API endpoints.
  - Acceptance: GET /api/reports/timesheet?from=2026-02-10&to=2026-02-17 returns JSON with entries grouped by date, including project_name, client_name, hourly_rate, duration, and calculated amount (hours x rate). Daily subtotals and grand total are included. GET /api/reports/timesheet/csv with same params returns a downloadable CSV with headers: Date, Project, Client, Description, Hours, Rate, Amount. The Reports tab in the frontend successfully generates and displays a timesheet. CSV export downloads a valid file.


## Verification

- [x] **1.10**: Write comprehensive API tests (tests/conftest.py + tests/test_api_projects.py + tests/test_api_entries.py + tests/test_api_timer.py): conftest.py provides fixtures for a test database (tempfile, cleaned between tests) and httpx.AsyncClient using httpx.ASGITransport(app=app) for in-process testing (NO network port needed). Test coverage: Projects CRUD (create, list, get, update, list active filter, delete with/without entries, 404/409 errors). Timer (start, get running, stop, auto-switch when starting while one runs, stop when none running). Entries (create manual, list by date, list by date range, update, delete, entries include project_name and project_color). Error handling (missing fields return 400/422, not found returns 404).
  - Value: Ensures the freelancer can trust that the API behaves correctly in all cases — preventing silent data loss, incorrect durations, or confusing errors that would undermine confidence in the tool.
  - Acceptance: All API tests pass with pytest. Tests use in-process httpx.AsyncClient (no network port). Test database is a temp file cleaned between tests. Coverage includes: at least 3 project CRUD tests, at least 3 timer flow tests (start/stop/auto-switch), at least 3 entry tests (create manual, list by date, delete), at least 2 error handling tests (404, 409).
  - Deps: 1.5

- [B] **1.11**: Write Playwright frontend tests (tests/test_frontend_timer.py, tests/test_frontend_projects.py): conftest.py adds fixtures to start the FastAPI server on a dynamic port (find free port, start uvicorn in subprocess, wait for health, yield, shutdown) with a temp database. test_frontend_timer.py: navigate to app, create a project via API, select project in dropdown, click Start, verify timer display shows and counts, click Stop, verify entry appears in today list with correct project. test_frontend_projects.py: navigate to Projects tab, click New Project, fill form, submit, verify card appears in list. Tests use pytest-playwright page fixture pointed at the running server.
  - Value: Validates the full user experience end-to-end — proving that a real browser can perform the exact workflow a freelancer would: create a project, start a timer, stop it, and see the result. This catches integration bugs between frontend and API that unit tests miss.
  - Acceptance: All Playwright tests pass. Server starts on a dynamic port with a temp database. Timer test: creates project, starts timer, sees counting display, stops, sees entry in list. Projects test: creates project via UI form, sees it in project list. No flaky timeouts (use proper Playwright locators and expect conditions). Tests clean up server process after completion.
  - Deps: 1.7, 1.9, 1.10
