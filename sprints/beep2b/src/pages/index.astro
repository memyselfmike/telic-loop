---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import FeatureCard from '../components/FeatureCard.astro';
import TestimonialCard from '../components/TestimonialCard.astro';
import { getPageBySlug, urlForImage, type Testimonial } from '../lib/sanity';

// Fetch home page content from CMS
const pageData = await getPageBySlug('home');

// Extract sections from CMS data
const heroSection = pageData?.sections?.find((s) => s._type === 'hero');
const featuresSection = pageData?.sections?.find((s) => s._type === 'features');
const testimonialsSection = pageData?.sections?.find((s) => s._type === 'testimonials');
const ctaSection = pageData?.sections?.find((s) => s._type === 'cta');

// Fallback content when CMS is unavailable
const fallbackHero = {
  eyebrow: 'LinkedIn Lead Generation for B2B',
  heading: 'Consistent B2B Leads\nFrom LinkedIn',
  subheading: 'Stop guessing. The BEEP methodology gives you a repeatable system for generating qualified leads on LinkedIn ‚Äî without cold calls, spam, or unpredictable results.',
  primaryCta: 'Book a Discovery Call',
  primaryCtaHref: '/contact',
  secondaryCta: 'See How It Works',
  secondaryCtaHref: '/how-it-works',
  trustItems: ['500+ clients served', '22 countries', 'Est. 2014'],
};

const fallbackFeatures = [
  {
    icon: 'üéØ',
    title: 'Precision Targeting',
    description: 'We identify and connect with prospects who match your exact ideal customer profile ‚Äî no broad blasting, no wasted time.',
  },
  {
    icon: 'ü§ù',
    title: 'Relationship-First',
    description: 'BEEP builds trust before pitching. When you promote, you\'re talking to a warm audience that already sees your value.',
  },
  {
    icon: 'üìà',
    title: 'Predictable Pipeline',
    description: 'Systematic outreach means consistent results month after month ‚Äî not spikes and droughts driven by random effort.',
  },
  {
    icon: '‚úçÔ∏è',
    title: 'Thought Leadership',
    description: 'Position yourself as the go-to authority in your niche with expert content that attracts inbound enquiries.',
  },
  {
    icon: 'üìä',
    title: 'Transparent Reporting',
    description: 'Monthly performance reports show exactly what activity was done, what results it produced, and what\'s planned next.',
  },
  {
    icon: 'üéì',
    title: 'Training and Playbooks',
    description: 'Prefer to run it in-house? We train your team with the exact same systems we use for managed clients.',
  },
];

const fallbackTestimonials = [
  {
    quote: 'Within 3 months of implementing BEEP, I was having 4 to 5 qualified discovery calls a week. Before, I was lucky to get one a month.',
    name: 'Sarah M.',
    role: 'Founder, B2B SaaS',
    country: 'UK',
  },
  {
    quote: 'The methodology is so systematic. I knew exactly what to do every day, and the results were predictable. That is rare in marketing.',
    name: 'James K.',
    role: 'Sales Director',
    country: 'Australia',
  },
  {
    quote: 'We trained our whole team. Within 6 weeks, 3 reps had LinkedIn as their top lead source. The ROI on the training was obvious.',
    name: 'Anja W.',
    role: 'VP Marketing',
    country: 'Germany',
  },
];

const fallbackCta = {
  heading: 'Ready to Grow Your B2B Pipeline?',
  description: "Book a free 30-minute discovery call. We'll review your current LinkedIn presence and show you exactly how BEEP would work for your business.",
  buttonText: 'Book Your Free Discovery Call',
  buttonLink: '/contact',
};

// Prepare hero props (CMS or fallback)
const heroProps = heroSection ? {
  eyebrow: undefined, // CMS hero doesn't have eyebrow field
  heading: heroSection.heading,
  subheading: heroSection.subheading,
  primaryCta: heroSection.ctaText,
  primaryCtaHref: heroSection.ctaLink,
  secondaryCta: undefined, // CMS hero only has one CTA
  secondaryCtaHref: undefined,
  trustItems: fallbackHero.trustItems, // Trust items not in CMS schema, use fallback
} : fallbackHero;

// Prepare features (CMS or fallback)
const features = featuresSection?.items || fallbackFeatures;

// Prepare testimonials (CMS or fallback)
const testimonials = testimonialsSection?.items as Testimonial[] | undefined || fallbackTestimonials;

// Prepare CTA (CMS or fallback)
const cta = ctaSection || fallbackCta;
---

<BaseLayout
  title="Beep2B ‚Äî Consistent B2B Leads From LinkedIn"
  description="Beep2B helps B2B entrepreneurs and marketers generate high-quality LinkedIn leads through the proven BEEP methodology. Join 500+ businesses across 22 countries."
>
  <main>

    <!-- Hero Section -->
    <Hero
      eyebrow={heroProps.eyebrow}
      heading={heroProps.heading}
      subheading={heroProps.subheading}
      primaryCta={heroProps.primaryCta}
      primaryCtaHref={heroProps.primaryCtaHref}
      secondaryCta={heroProps.secondaryCta}
      secondaryCtaHref={heroProps.secondaryCtaHref}
      trustItems={heroProps.trustItems}
    />

    <!-- What We Do ‚Äî Feature Cards -->
    <section class="py-16 px-4 bg-white">
      <div class="max-w-5xl mx-auto">
        <div class="text-center mb-10">
          <h2 class="text-3xl font-bold text-slate-900 mb-3">
            {featuresSection?.heading || 'Everything You Need to Generate B2B Leads on LinkedIn'}
          </h2>
          <p class="text-slate-600 max-w-2xl mx-auto">
            Beep2B combines strategy, execution, and training to deliver qualified
            prospects into your pipeline ‚Äî consistently.
          </p>
        </div>
        <div class="grid md:grid-cols-3 gap-6">
          {features.map((feature) => (
            <FeatureCard
              icon={feature.icon}
              title={feature.title}
              description={feature.description}
            />
          ))}
        </div>
      </div>
    </section>

    <!-- BEEP Method Preview -->
    <section class="py-16 px-4 bg-slate-50">
      <div class="max-w-5xl mx-auto">
        <div class="text-center mb-10">
          <p class="text-primary-600 text-sm font-semibold uppercase tracking-widest mb-2">
            Our Methodology
          </p>
          <h2 class="text-3xl font-bold text-slate-900 mb-3">
            The BEEP Method
          </h2>
          <p class="text-slate-600 max-w-xl mx-auto">
            Four steps. One system. Repeatable results. BEEP works because it mirrors how real buying decisions happen.
          </p>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          {[
            { letter: 'B', step: 'Build', desc: 'Grow your network with precision-targeted connections.', num: '01' },
            { letter: 'E', step: 'Engage', desc: 'Start authentic, goal-based conversations.', num: '02' },
            { letter: 'E', step: 'Educate', desc: 'Deliver valuable content that builds authority.', num: '03' },
            { letter: 'P', step: 'Promote', desc: 'Present offers to a warm, trusting audience.', num: '04' },
          ].map((item) => (
            <div class="bg-white rounded-xl p-5 border border-primary-100 text-center shadow-sm">
              <div class="w-12 h-12 rounded-full bg-primary-800 text-white font-extrabold text-2xl flex items-center justify-center mx-auto mb-3">
                {item.letter}
              </div>
              <div class="text-xs text-primary-500 font-semibold mb-1">Step {item.num}</div>
              <h3 class="font-bold text-slate-900 mb-1">{item.step}</h3>
              <p class="text-xs text-slate-500 leading-relaxed">{item.desc}</p>
            </div>
          ))}
        </div>
        <div class="text-center">
          <a
            href="/how-it-works"
            class="inline-flex items-center gap-2 text-primary-700 font-semibold hover:text-primary-900 transition-colors"
          >
            Learn the full BEEP methodology
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    </section>

    <!-- Testimonials -->
    <section class="py-16 px-4 bg-white">
      <div class="max-w-5xl mx-auto">
        <div class="text-center mb-10">
          <h2 class="text-3xl font-bold text-slate-900 mb-3">
            {testimonialsSection?.heading || 'What Our Clients Say'}
          </h2>
          <p class="text-slate-600">
            Real results from real B2B businesses using the BEEP methodology.
          </p>
        </div>
        <div class="grid md:grid-cols-3 gap-6">
          {testimonials.map((testimonial) => {
            // Handle both CMS testimonials (with image field) and fallback testimonials
            const isCmsTestimonial = '_id' in testimonial;
            const avatarUrl = isCmsTestimonial && testimonial.image
              ? urlForImage(testimonial.image)
              : undefined;
            const role = isCmsTestimonial && testimonial.company
              ? `${testimonial.role || ''}, ${testimonial.company}`.trim()
              : testimonial.role || '';

            return (
              <TestimonialCard
                quote={testimonial.quote}
                name={testimonial.name}
                role={role}
                country={'country' in testimonial ? testimonial.country : undefined}
                avatarUrl={avatarUrl}
              />
            );
          })}
        </div>
      </div>
    </section>

    <!-- CTA Banner -->
    <section class="bg-brand py-16 px-4 text-center">
      <div class="max-w-2xl mx-auto">
        <h2 class="text-3xl md:text-4xl font-bold text-white mb-4">
          {cta.heading}
        </h2>
        <p class="text-primary-100 text-lg mb-8 leading-relaxed">
          {cta.description || cta.buttonText}
        </p>
        <a
          href={cta.buttonLink}
          class="inline-flex items-center px-10 py-4 bg-white text-primary-800 font-bold rounded-md hover:bg-primary-50 transition-colors text-lg shadow-lg"
        >
          {cta.buttonText}
        </a>
        <p class="text-primary-300 text-sm mt-4">No commitment. No pressure. Just an honest conversation.</p>
      </div>
    </section>

  </main>
</BaseLayout>
